<script src="https://cdn.rawgit.com/nnattawat/flip/master/dist/jquery.flip.min.js"></script>

<div class="container" style="padding-top:70px">    
  <!--  user authentication -->
  <% if user_signed_in? %>
  <div class="row">
    <div class="col-md-2">
      <div class="row">
        <%= image_tag(current_user.image.url, class: "img-responsive img-circle", style: "margin: 10px; height: 30px; width: 30px") %>
        <a href="<%= user_path(current_user) %>" class="navbar-brand col"><%= current_user.name %></a>
      </div>
      <div class="row">
        <a href="#" class: "btn" style="margin: 6px 30px">News Feed</a>
      </div>
      <div class="row">
        <a href="#" class: "btn" style="margin: 6px 30px">Messenger</a>
      </div>
      <div class="row">
      </div>
    </div>
    <div class="col-md-7 col-md-pull-1">       
    <% @posts.each do |post| %>
      <div class="col-md-12">
        <div class="panel">
          <div class="panel-heading">
            <% user = User.find_by(id: post.user_id) %>
            <div class="col-md-1 col-xs-3 col-sm-3 card2" style="padding: 5px">
              <div class="front"> 
                <%= image_tag user.image.url, class: "img-circle", size: "40x40" %>
              </div> 
              <div class="back img-circle" style="background-color: black; max-height: 40px; max-width: 40px; opacity: 0.7">
                <div style="background-color: white">
                  <h7 style="margin-top: 10px"><%= user.name %></h7>
                </div>  
              </div>
              <script>$(".card2").flip({
                axis: 'y',
                trigger: 'click'
              }); 
              </script>
            </div>
            <div class="col-md-4 col-xs-6 col-sm-6 name">
              <%= link_to user.name, user  %>
              <% created = post.created_at %>
              <% year = @time_now.year - created.year %>
              <% month = @time_now.month - created.month %>
              <% day = @time_now.day - created.day %>
              <% hour = @time_now.hour - created.hour %>
              <% min = @time_now.min - created.min %>
              <% sec = @time_now.sec - created.sec %>
              <% if year > 0 %>
                <h5><%= year %> years ago</h5>
              <% elsif month > 0 %>  
                <h5><%= month %> months ago</h5>
              <% elsif day > 0 %>  
                <h5><%= day %> days ago at <%= post.created_at.hour %>:<%= post.created_at.min %></h5>
              <% elsif hour > 0 %>  
                <h5><%= hour %> hours ago at <%= post.created_at.hour %>:<%= post.created_at.min %></h5>  
              <% elsif min > 0 %>  
                <h5><%= min %> minutes ago</h5>
              <% elsif sec > 0 %>
                <h5><%= sec %> seconds ago</h5>                  
              <% end %>
            </div>
            <div class="col-md-5 col-md-push-6">
              <div class="dropdown">
                <button class="btn btn1 glyphicon glyphicon-option-horizontal" type="button" data-toggle="dropdown", style="padding-top: 15px"></button>
                <ul class="dropdown-menu">
                  <div class="col-md-12 btn-group">
                    <div class="row">
                      <span class="glyphicon glyphicon-edit" style="padding-left: 5px; font-size: 150%; margin-top: 5px"></span>&nbsp&nbsp                   
                      <%= link_to 'Edit Post', edit_post_path(post), class: "btn btn-default", style: "padding: 6px 39px" %>&nbsp&nbsp
                    </div><br>
                    <div class="row">
                      <span class="glyphicon glyphicon-trash" style="padding-left: 5px; font-size: 150%; margin-top: 5px"></span>&nbsp&nbsp                    
                      <%= link_to 'Delete Post', post, method: :delete, data: { confirm: 'Are you sure?' }, class: " delete_post btn btn-default", style: "padding: 6px 30px", remote: :true %>&nbsp&nbsp
                    </div>  
                  </div>
                </ul>
              </div>
            </div>              
          </div><br><br><br>
          <div class="panel-body"> 
            <div class="row">    
              <div class="col-md-12 text-center">
                <h2><%= post.description %></h2> 
                <% if post.image.present? %>                  
                <div class="card" style="max-height: 400px"> 
                  <div class="front"> 
                    <%= image_tag post.image.url, class: "img-responsive text-center", style: "margin: auto; background-size: auto" %><br/><br/>
                  </div> 
                  <div class="back">
                    <div style="background-color: #284c79">
                      <h1><%= post.description %></h1>
                      <h3>Post Created At: <br> <%= post.created_at.inspect %></h3>
                    </div>  
                  </div>
                  <script>$(".card").flip({
                    axis: 'y',
                    trigger: 'click'
                  }); 
                  </script> 
                </div>
                <% else %>
                <h1><%= post.description %></h1>  
                <% end %>                               
              </div>
            </div><hr>  
            <div class="row">
                <% if !post.likes.find_by(user_id: current_user.id) %>
                  <div class="col-md-3 col-md-push-1 col-xs-3 col-sm-3 col-xs-push-1 col-sm-push-1">
                    <div class="row">
                      <span class="glyphicon glyphicon-thumbs-up" style="font-size: 170%"></span>  
                      <%= bootstrap_form_for(Like.new, :url => post_likes_path(post_id: post.id)) do |f| %> 
                        <%= f.submit "Like", class: "btn btn2" %>
                      <% end %>
                    </div>
                  </div>                       
                <% else %>
                  <div class="col-md-3 col-sm-4 col-xs-4 col-md-push-1 col-xs-push-1 col-sm-push-1">
                    <div class="row">                    
                      <span class="glyphicon glyphicon-thumbs-down" style="font-size: 170%"></span>
                      <% like = post.likes.find_by(post_id: post.id, user_id: current_user.id) %>  
                      <%= link_to 'UnLike', post_like_path(post_id: post.id, id: like.id), method: :delete, class: "btn btn2" %>
                    </div>                      
                  </div>  
                <% end %>
                <div class="col-md-3 col-sm-4 col-xs-5">
                  <span class="glyphicon glyphicon-comment" style="font-size: 120%"></span>
                  <a href="#comment" class="btn btn2">Comment</a>
                </div>
                <div class="col-md-3 col-sm-4 col-xs-3">
                  <%= image_tag("share-icon.png", size: "20x20", style: "margin-top: -10px; margin-left: -15px") %>
                  <a href="#" class="btn btn2">Share</a>
                </div>                
              </div>                             
          </div>
          <div class="panel-footer" id="comment">
            <div class="col-md-12"> 
              <div class="col-md-6 col-xs-12 col-sm-12">
                <div class="row">
                  <% like_names = Like.where(post_id: post.id).limit(3) %>
                  <% if post.likes %>
                    <% like_names.each do |user| %>
                      <% user = user.user_id %>
                      <% user = User.find_by(id: user) %>
                      <h5 style="color: blue"><a href="<%= user_path(user) %>"><%= user.name %></a></h5>
                      <% if like_names.last.user_id != user.id %>
                        <h7 style="color: #00a3cc; font-size: 160%">,&nbsp</h7>
                      <% end %>
                    <% end %>
                    <% if like_names.count > 1 %>
                      <h5 style="color: blue">....</h5>
                    <% end %>
                  <% end %>
                  <% if post.likes.count > 0 %>
                    <h3 class="label" style="color: black; font-size: 120%; margin-top: 5px"><%= post.likes.count %></h3>
                  <% end %>  
                </div>    
              </div>                  
            </div><br><br>
            <!-- post Comments -->
            <div class="panel font" style="background-color: inherit"> 
              <div class="panel-body">
                <div class="row">
                  <div class="col-md-12 col-sm-12 col-xs-12">
                    <%= bootstrap_form_for(Comment.new, :url => post_comments_path(post_id: post.id)) do |f| %> 
                    <%= f.text_area :description, size: "300x1", hide_label: true, placeholder: "Write a comment..." , style: "border-radius: 15px;" %>
                    <%= f.submit "Submit Comment", class: "btn btn2", style: "border: 1px solid black; margin-left: 3px" %><br><br>
                    <% end %>
                  </div>
                </div>           
                <div class="row">
                  <% comments = post.comments.all %>
                  <% comments.each do |com| %>
                  <% user = User.find_by(id: com.user_id) %>
                  <div class="row">
                    <% if com.description %>
                    <div class="col-md-6 col-sm-6 col-xs-6 col-md-push-2 col-xs-push-2">
                      <div class="row">
                        <h4><%= user.name.capitalize %>: <%= com.description %></h4>   
                      </div>  
                    </div>
                    <div class="col-md-6 col-md-push-12 col-sm-6 col-xs-6 col-xs-push-10">    
                      <div class="dropdown">
                        <div class="col-md-4 col-xs-3 col-sm-4 btn-group">
                          <button class="btn btn1 glyphicon glyphicon-option-horizontal" type="button" data-toggle="dropdown", style="padding-top: 15px"></button>
                          <ul class="dropdown-menu">
                            <span class="glyphicon glyphicon-edit" style="padding-left: 5px"></span>
                            <%= link_to 'Edit...', edit_post_comment_path(post_id: post.id,id: com.id), class: "btn btn3" %><br>
                            <span class="glyphicon glyphicon-trash" style="padding-left: 5px"></span>
                            <%= link_to 'Delete...', post_comment_path(post_id: post.id,id: com.id), method: :delete, data: { confirm: 'Are you sure?' }, class: "btn btn3" %>
                          </ul>  
                        </div>
                      </div>
                    </div>  
                    <% end %>    
                      </div>       
                      <% end %><br>
                    <div class="row">  
                      <% if !comments %>
                        <h4>Be The First One To Comment</h4>
                      <% end %> 
                    </div>       
                    <div class="col-md-3">
                    </div>                
                  </div>            
                </div> 
              </div>
            </div> 
          </div>
        </div>            
        <% end %> 
      </div>    
      <% else %>
      <div class="row">
        <h1>Please sign In Or Sign Up before trying to view or modify the Feed</h1>
      </div>
      <% end %>
    </div>
    </div>
